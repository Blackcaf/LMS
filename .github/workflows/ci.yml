name: ğŸš€ LMS CI Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½Ñ‹Ñ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
  detect-changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      auth-service: ${{ steps.filter.outputs.auth-service }}
      course-service: ${{ steps.filter.outputs.course-service }}
      user-service: ${{ steps.filter.outputs.user-service }}
      notification-service: ${{ steps.filter.outputs.notification-service }}
      common: ${{ steps.filter.outputs.common }}
      run-all: ${{ steps.filter.outputs.run-all }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth-service:
              - 'auth-service/**'
            course-service:
              - 'course-service/**'
            user-service:
              - 'user-service/**'
            notification-service:
              - 'notification-service/**'
            common:
              - 'common/**'
              - 'build.gradle*'
              - 'settings.gradle*'
              - 'gradle/**'
            run-all:
              - '.github/workflows/**'
              - 'build.gradle*'
              - 'settings.gradle*'

  # Ğ¢ĞµÑÑ‚Ñ‹ Ğ´Ğ»Ñ Auth Service
  test-auth-service:
    name: ğŸ” Auth Service Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.auth-service == 'true' || needs.detect-changes.outputs.common == 'true' || needs.detect-changes.outputs.run-all == 'true'
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: lms_password
          POSTGRES_USER: lms_user
          POSTGRES_DB: lmsdb
        options: >-
          --health-cmd "pg_isready -U lms_user -d lmsdb"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: â˜• Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ§ª Run Auth Service Tests
        run: ./gradlew :auth-service:test --info

      - name: ğŸ“Š Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Auth Service Tests
          path: 'auth-service/build/test-results/test/*.xml'
          reporter: java-junit

  # Ğ¢ĞµÑÑ‚Ñ‹ Ğ´Ğ»Ñ Course Service
  test-course-service:
    name: ğŸ“š Course Service Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.course-service == 'true' || needs.detect-changes.outputs.common == 'true' || needs.detect-changes.outputs.run-all == 'true'
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: lms_user
          MONGO_INITDB_ROOT_PASSWORD: lms_password
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017

    steps:
      - uses: actions/checkout@v4

      - name: â˜• Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ§ª Run Course Service Tests
        run: ./gradlew :course-service:test --info

      - name: ğŸ“Š Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Course Service Tests
          path: 'course-service/build/test-results/test/*.xml'
          reporter: java-junit

  # Ğ¢ĞµÑÑ‚Ñ‹ Ğ´Ğ»Ñ User Service
  test-user-service:
    name: ğŸ‘¤ User Service Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.user-service == 'true' || needs.detect-changes.outputs.common == 'true' || needs.detect-changes.outputs.run-all == 'true'
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: lms_password
          POSTGRES_USER: lms_user
          POSTGRES_DB: lmsdb
        options: >-
          --health-cmd "pg_isready -U lms_user -d lmsdb"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: â˜• Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ§ª Run User Service Tests
        run: ./gradlew :user-service:test --info

      - name: ğŸ“Š Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: User Service Tests
          path: 'user-service/build/test-results/test/*.xml'
          reporter: java-junit

  # Ğ¢ĞµÑÑ‚Ñ‹ Ğ´Ğ»Ñ Notification Service
  test-notification-service:
    name: ğŸ“§ Notification Service Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.notification-service == 'true' || needs.detect-changes.outputs.common == 'true' || needs.detect-changes.outputs.run-all == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: â˜• Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ§ª Run Notification Service Tests
        run: ./gradlew :notification-service:test --info

      - name: ğŸ“Š Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Notification Service Tests
          path: 'notification-service/build/test-results/test/*.xml'
          reporter: java-junit

  # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ° ĞºĞ¾Ğ´Ğ°
  code-quality:
    name: ğŸ¨ Code Quality
    runs-on: ubuntu-latest
    needs: detect-changes

    steps:
      - uses: actions/checkout@v4

      - name: â˜• Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ¨ Checkstyle
        run: ./gradlew checkstyleMain checkstyleTest
        continue-on-error: true

      - name: ğŸ› SpotBugs
        run: ./gradlew spotbugsMain
        continue-on-error: true

  # Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ²ÑĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
  build:
    name: ğŸ“¦ Build All Services
    runs-on: ubuntu-latest
    needs: [test-auth-service, test-course-service, test-user-service, test-notification-service, code-quality]
    if: always() && (needs.test-auth-service.result == 'success' || needs.test-auth-service.result == 'skipped') && (needs.test-course-service.result == 'success' || needs.test-course-service.result == 'skipped') && (needs.test-user-service.result == 'success' || needs.test-user-service.result == 'skipped') && (needs.test-notification-service.result == 'success' || needs.test-notification-service.result == 'skipped')

    steps:
      - uses: actions/checkout@v4

      - name: â˜• Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ“¦ Build JARs
        run: ./gradlew build -x test

      - name: ğŸ“‹ List Artifacts
        run: |
          echo "ğŸ“¦ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ JAR Ñ„Ğ°Ğ¹Ğ»Ñ‹:"
          find . -name "*.jar" -type f | grep -v "gradle-wrapper" | grep "build/libs"

      - name: âœ… Summary
        run: |
          echo "ğŸ¯ =========================================="
          echo "ğŸ¯       Ğ¡Ğ‘ĞĞ ĞšĞ Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ!"
          echo "ğŸ¯ =========================================="
